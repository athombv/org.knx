<style type="text/css">
    .knx-wrap fieldset select,
    .knx-wrap fieldset input[type="text"] {
        max-width: 200px;
        /*float: right;*/
        margin-left: 0.4em;
    }

    .knx-wrap fieldset .row label {
        width: auto;
    }

    .knx-wrap fieldset input[type="text"] {
        max-width: 70px;
    }

    .knx-wrap fieldset select {
        display: none;
    }

    .knx-wrap .knx-entry {
        overflow: hidden;
    }

    .knx-wrap .knx-entry:not(:last-child) {
        padding-bottom: 0.4em;
    }

    .knx-wrap .margin-top {
        margin-top: 10px;
    }
</style>
<div class="knx-wrap" id="ga_input">
	<p data-i18n="settings.groupaddresses.body">
	</p>
	<fieldset id="knx-light-fieldset" style="display: none">
		<div class="knx-light field row">
			<div class="knx-entry">
				<label for="toggle_address" class="left" data-i18n="settings.groupaddresses.switch.toggle"></label>
			</div>
			<div class="knx-entry">
				<select id="light_ga_dropdown" class="knx-dropdown right"></select>
				<input id="toggle_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="toggle_status_address" class="left"
					   data-i18n="settings.groupaddresses.generic_status"></label>
			</div>
			<div class="knx-entry">
				<select id="statusga_dropdown" class="knx-dropdown right"></select>
				<input id="toggle_status_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
		</div>
	</fieldset>
	<fieldset id="knx-switch-fieldset" style="display: none">
		<div class="knx-switch field row">
			<div class="knx-entry">
				<label for="switch_toggle_address" class="left"
					   data-i18n="settings.groupaddresses.switch.toggle"></label>
			</div>
			<div class="knx-entry">
				<select id="switchga_dropdown" class="knx-dropdown right"></select>
				<input id="switch_toggle_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="switch_status_address" class="left"
					   data-i18n="settings.groupaddresses.switch.status"></label>
			</div>
			<div class="knx-entry">
				<select id="switch_statusga_dropdown" class="knx-dropdown right"></select>
				<input id="switch_status_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
		</div>
	</fieldset>
	<fieldset id="knx-dimmer-fieldset" style="display: none">
		<div class="knx-dimmer field row">
			<div class="knx-entry">
				<label for="dim_address" class="left" data-i18n="settings.groupaddresses.dimmer.value"></label>
			</div>
			<div class="knx-entry">
				<select id="dimga_dropdown" class="knx-dropdown right"></select>
				<input id="dim_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry" id="knx-dimmer-status-entry">
				<label for="dim_status_address" class="left" data-i18n="settings.groupaddresses.dimmer.status"></label>
			</div>
			<div class="knx-entry">
				<select id="dim_statusga_dropdown" class="knx-dropdown right"></select>
				<input id="dim_status_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
		</div>
	</fieldset>
	<fieldset id="knx-rgb-fieldset" style="display: none">
		<div class="knx-rgb field row">
			<div class="knx-entry">
				<label for="red_toggle_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.red_toggle_action"></label>
			</div>
			<div class="knx-entry">
				<select id="red_toggle_dropdown" class="knx-dropdown right"></select>
				<input id="red_toggle_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="red_toggle_status_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.red_toggle_status"></label>
			</div>
			<div class="knx-entry">
				<select id="red_toggle_status_dropdown" class="knx-dropdown right"></select>
				<input id="red_toggle_status_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="red_dim_label" class="left" data-i18n="settings.groupaddresses.rgb.red_dim_value"></label>
			</div>
			<div class="knx-entry">
				<select id="red_dim_dropdown" class="knx-dropdown right"></select>
				<input id="red_dim_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="red_dim_status_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.red_dim_status"></label>
			</div>
			<div class="knx-entry">
				<select id="red_dim_status_dropdown" class="knx-dropdown right"></select>
				<input id="red_dim_status_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
		</div>
		<div class="knx-rgb field row">
			<div class="knx-entry">
				<label for="green_toggle_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.green_toggle_action"></label>
			</div>
			<div class="knx-entry">
				<select id="green_toggle_dropdown" class="knx-dropdown right"></select>
				<input id="green_toggle_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="green_toggle_status_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.green_toggle_status"></label>
			</div>
			<div class="knx-entry">
				<select id="green_toggle_status_dropdown" class="knx-dropdown right"></select>
				<input id="green_toggle_status_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="green_dim_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.green_dim_value"></label>
			</div>
			<div class="knx-entry">
				<select id="green_dim_dropdown" class="knx-dropdown right"></select>
				<input id="green_dim_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="green_dim_status_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.green_dim_status"></label>
			</div>
			<div class="knx-entry">
				<select id="green_dim_status_dropdown" class="knx-dropdown right"></select>
				<input id="green_dim_status_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
		</div>
		<div class="knx-rgb field row">
			<div class="knx-entry">
				<label for="blue_toggle_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.blue_toggle_action"></label>
			</div>
			<div class="knx-entry">
				<select id="blue_toggle_dropdown" class="knx-dropdown right"></select>
				<input id="blue_toggle_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="blue_toggle_status_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.blue_toggle_status"></label>
			</div>
			<div class="knx-entry">
				<select id="blue_toggle_status_dropdown" class="knx-dropdown right"></select>
				<input id="blue_toggle_status_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="blue_dim_label" class="left" data-i18n="settings.groupaddresses.rgb.blue_dim_value"></label>
			</div>
			<div class="knx-entry">
				<select id="blue_dim_dropdown" class="knx-dropdown right"></select>
				<input id="blue_dim_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="blue_dim_status_label" class="left"
					   data-i18n="settings.groupaddresses.rgb.blue_dim_status"></label>
			</div>
			<div class="knx-entry">
				<select id="blue_dim_status_dropdown" class="knx-dropdown right"></select>
				<input id="blue_dim_status_input" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
		</div>
	</fieldset>
	<fieldset id="knx-thermostat-fieldset" style="display: none">
		<div class="knx-thermostat field row">
			<div class="knx-entry">
			<label for="temperature_target_address" class="left"
				   data-i18n="settings.groupaddresses.thermostat.target"></label>
			</div>
			<div class="knx-entry">
				<input id="temperature_target_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
				<select id="temperature_target_ga_dropdown" class="knx-dropdown right"></select>

			</div>
			<div class="knx-entry">
			<label for="temperature_measure_address" class="left"
				   data-i18n="settings.groupaddresses.thermostat.measure"></label>
			</div>
			<div class="knx-entry">
				<input id="temperature_measure_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
				<select id="temperature_measure_ga_dropdown" class="knx-dropdown right"></select>
			</div>
		</div>
	</fieldset>
	<fieldset id="knx-windowcovering-fieldset" style="display: none">
		<div class="knx-windowcovering field row">
			<div class="knx-entry">
				<label for="windowcover_updown_address" class="left"
					   data-i18n="settings.groupaddresses.windowcovering.updown"></label>
			</div>
			<div class="knx-entry">
				<select id="windowcover_updown_ga_dropdown" class="knx-dropdown right"></select>
				<input id="windowcover_updown_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="windowcover_stop_address" class="left"
					   data-i18n="settings.groupaddresses.windowcovering.stop"></label>
			</div>
			<div class="knx-entry">
				<select id="windowcover_stopga_dropdown" class="knx-dropdown right"></select>
				<input id="windowcover_stop_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="windowcover_status_address" class="left"
					   data-i18n="settings.groupaddresses.generic_status"></label>
			</div>
			<div class="knx-entry">
				<select id="windowcover_statusga_dropdown" class="knx-dropdown right"></select>
				<input id="windowcover_status_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
		</div>
	</fieldset>
	<fieldset id="knx-sensor-fieldset" style="display: none">
		<div class="knx-sensor field row">
			<div class="knx-entry">
				<label for="sensor_address" class="left" data-i18n="settings.groupaddresses.sensor"></label>
			</div>
			<div class="knx-entry">
				<select id="sensor_ga_dropdown" class="knx-dropdown right"></select>
				<input id="sensor_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
		</div>
	</fieldset>
	<fieldset id="knx-scene-fieldset" style="display: none">
		<div class="knx-scene field row">
			<div class="knx-entry">
				<label for="scene_address" class="left" data-i18n="settings.groupaddresses.scene"></label>
			</div>
			<div class="knx-entry">
				<select id="scene_ga_dropdown" class="knx-dropdown right"></select>
				<input id="scene_address" type="text" class="knx-text" placeholder="e.g. 0/1/2" />
			</div>
			<div class="knx-entry">
				<label for="scene_number" class="left" data-i18n="settings.scene_number"></label>
			</div>
			<div class="knx-entry">
				<input id="scene_number" type="text" class="knx-text" placeholder="e.g. 8" />
			</div>
		</div>
	</fieldset>
	<fieldset id="knx-learnmode-fieldset" style="display: none">
		<label id="learnmode_label" data-i18n="settings.learnmode.explanation"></label>
		<div class="knx-entry">
			<button id="learnmode_button" class="left" data-i18n="settings.learnmode.title"></button>
		</div>
		<div class="knx-entry margin-top">
			<button id="test_button" class="right" style="display: none"
					data-i18n="settings.learnmode.testbutton"></button>
			<select id="learnmode_dropdown" class="left" style="display: none"></select>
		</div>
	</fieldset>
	<p id="xmltext" data-i18n="settings.projectfile.newxml.explanation"></p>
	<button id="save_button" class="right" data-i18n="settings.groupaddresses.save"></button>
</div>
<script>
  Homey.setTitle(Homey.__('settings.groupaddresses.body'));
  // Global variables
  var deviceType;
  var deviceUuid; //const?
  var interfaceMAC;
  var groupAddresses;

  Homey.emit('return_selected_interface')
    .then(function (macAddress) {
      interfaceMAC = macAddress;
    })
    .catch(function (error) {
      Homey.alert(error);
    });

  Homey.emit('get_uuid')
    .then(function (uuid) {
      console.log(uuid); // result is: Hello!, function (error, uuid) {
      deviceUuid = uuid;
    });

  Homey.getOptions()
    .then(function (options) {
      deviceType = options.devicetype;

      displayDeviceTypeFields();
    })
    .catch(function (error) {
      Homey.alert(error);
    });

  function displayDeviceTypeFields() {
    switch (deviceType) {
      case 'light':
        console.log('device is a light');
        $('#knx-light-fieldset').css('display', 'block');
        break;
      case 'switch':
        console.log('device is a switch');
        $('#knx-switch-fieldset').css('display', 'block');
        $('#knx-learnmode-fieldset').css('display', 'block');
        break;
      case 'dimmer':
        console.log('device is a dimmer');
        $('#knx-light-fieldset').css('display', 'block');
        $('#knx-dimmer-fieldset').css('display', 'block');
        break;
      case 'dimcontrol':
        console.log('device is a dimcontrol');
        $('#knx-light-fieldset').css('display', 'block');
        $('#knx-dimmer-fieldset').css('display', 'block');
        $('#knx-dimmer-status-entry').css('display', 'none');
        break;
      case 'rgb':
        console.log('device is a rgb');
        $('#knx-rgb-fieldset').css('display', 'block');
        break;
      case 'thermostat':
        console.log('device is a thermostat');
        $('#knx-thermostat-fieldset').css('display', 'block');
        break;
      case 'windowcovering':
        console.log('device is a windowcovering');
        $('#knx-windowcovering-fieldset').css('display', 'block');
        break;
      case 'sensor':
        console.log('device is a sensor');
        $('#knx-sensor-fieldset').css('display', 'block');
        break;
      case 'scene':
        console.log('device is a scene');
        $('#knx-scene-fieldset').css('display', 'block');
        break;
    }
  }

  $learnmodeDropdown = $('#learnmode_dropdown');
  $learnmodeButton = $('#learnmode_button');
  $testButton = $('#test_button');

  var $xmlText = $('#xmltext');

  // Helper functions

  function listGroupAddressesDropdown(selectItem, filter) {
    groupAddresses.forEach(function (etsEntry) {
      var optionEl = document.createElement('option');
      optionEl.value = etsEntry.address;
      optionEl.textContent = etsEntry.name + Homey.__('settings.groupaddresses.pairing_list') + etsEntry.address;
      $(selectItem).append(optionEl);
    });
    $(selectItem).toggle(!!groupAddresses.length);
  }

  $('.knx-dropdown').on('change', function () {
    var value = $(this).val();
    $(this).next('.knx-text').val(value);
  });

  $learnmodeButton.on('click', function () {
    $learnmodeButton.attr('disabled', 'disabled');
    $learnmodeDropdown.innerHTML = '';

    Homey.emit('learnmode')
      .then(function (filteredList) {
        console.log('filteredList', filteredList);
        $learnmodeButton.removeAttr('disabled');

        if (filteredList && filteredList.length > 0) {
          filteredList.forEach(function (event) {
            var optionEl = document.createElement('option');
            optionEl.value = event.destination;
            optionEl.textContent = Homey.__('settings.groupaddresses.generic') + event.destination;
            $learnmodeDropdown.append(optionEl);
          });

          $learnmodeDropdown.toggle(!!filteredList.length);
          $testButton.toggle(!!filteredList.length);
          $('#switch_toggle_address').val($learnmodeDropdown.val());
        }
        else {
          Homey.alert(Homey.__('settings.learnmode.no_result'), 'info');
        }
      })
      .catch(function (error) {
        Homey.alert(Homey.__('errors.generic_error'), error.message || error.toString(), 'error');
      });
  });

  $learnmodeDropdown.on('change', function () {
    $('#switch_toggle_address').val($learnmodeDropdown.val());
  });

  $testButton.on('click', function () {
    $testButton.attr('disabled', 'disabled');
    var testTimeMs = 3200;
    Homey.emit('test_groupaddress', { address: $learnmodeDropdown.val(), time: testTimeMs })
	  .catch(function(error) {
        Homey.alert(error);
	  });

    setTimeout(function () {
      $testButton.removeAttr('disabled');
    }, testTimeMs);

    $('#toggle_address').val($learnmodeDropdown.val());
  });

  $('#save_button').on('click', function () {
    if (interfaceMAC) {
      console.log('Saving this device');

      var device = {
        data: {
          id: deviceUuid,
        },
      };

      switch (deviceType) {
        case 'light':
          device.name = 'KNX Light';
          device.settings = {
            'ga_switch': $('#toggle_address').val(),
            'ga_status': $('#toggle_status_address').val(),
            'macAddress': interfaceMAC,
          };
          break;
        case 'switch':
          device.name = 'KNX Switch';
          device.settings = {
            'ga_switch': $('#switch_toggle_address').val(),
            'ga_status': $('#switch_status_address').val(),
            'macAddress': interfaceMAC,
          };
          break;
        case 'dimmer':
          device.name = 'KNX Dimmer';
          device.settings = {
            'ga_switch': $('#toggle_address').val(),
            'ga_status': $('#toggle_status_address').val(),
            'ga_dim': $('#dim_address').val(),
            'ga_dim_status': $('#dim_status_address').val(),
            'macAddress': interfaceMAC,
          };
          break;
        case 'dimcontrol':
          device.name = 'KNX Relative Dimmer';
          device.settings = {
            'ga_switch': $('#toggle_address').val(),
            'ga_status': $('#toggle_status_address').val(),
            'ga_dim': $('#dim_address').val(),
            'macAddress': interfaceMAC,
          };
          break;
        case 'rgb':
          device.name = 'KNX RGB';
          device.settings = {
            'ga_red_toggle': $('#red_toggle_input').val(),
            'ga_red_toggle_status': $('#red_toggle_status_input').val(),
            'ga_red_dim': $('#red_dim_input').val(),
            'ga_red_dim_status': $('#red_dim_status_input').val(),
            'ga_green_toggle': $('#green_toggle_input').val(),
            'ga_green_toggle_status': $('#green_toggle_status_input').val(),
            'ga_green_dim': $('#green_dim_input').val(),
            'ga_green_dim_status': $('#green_dim_status_input').val(),
            'ga_blue_toggle': $('#blue_toggle_input').val(),
            'ga_blue_toggle_status': $('#blue_toggle_status_input').val(),
            'ga_blue_dim': $('#blue_dim_input').val(),
            'ga_blue_dim_status': $('#blue_dim_status_input').val(),
            'macAddress': interfaceMAC,
          };
          break;
        case 'thermostat':
          device.name = 'KNX Thermostat';
          device.settings = {
            'ga_temperature_target': $('#temperature_target_address').val(),
            'ga_temperature_measure': $('#temperature_measure_address').val(),
            'macAddress': interfaceMAC,
          };
          break;
        case 'windowcovering':
          device.name = 'KNX Windowcovering';
          device.settings = {
            'ga_up_down': $('#windowcover_updown_address').val(),
            'ga_stop': $('#windowcover_stop_address').val(),
            'ga_status': $('#windowcover_status_address').val(),
            'macAddress': interfaceMAC,
          };
          break;
        case 'sensor':
          device.name = 'KNX Sensor';
          device.settings = {
            'ga_sensor': $('#sensor_address').val(),
            'macAddress': interfaceMAC,
          };
          break;
        case 'scene':
          device.name = 'KNX Scene';
          device.settings = {
            'ga_scene': $('#scene_address').val(),
            'scene_number': $('#scene_number').val(),
            'macAddress': interfaceMAC,
          };
          break;
      }

      Homey.createDevice(device)
        .then(function () {
          Homey.done();
        })
        .catch(function (error) {
          Homey.alert(err);
        });
    }
    else {
      Homey.alert(Homey.__('errors.save_error'), Homey.__('errors.ip.interface_not_selected'));
    }
  });

  // Check if there are uploaded groupaddresses available
  Homey.emit('list_etsimport', function (error, groupAddressList) {
    if (error) {
      console.log('ets error', error.message, error.toString());
      return Homey.alert(Homey.__('errors.generic_error'), error.message || error.toString());
    }

    if (groupAddressList && groupAddressList.length > 0) {
      groupAddresses = groupAddressList;
      var $span = $('<span />').html(Homey.__('settings.projectfile.existingxml.title'));
      $xmlText.html($span);

      $('.knx-dropdown').each(function () {
        listGroupAddressesDropdown($(this));
      });
    }

    var $a = $('<a href="#">' + Homey.__('settings.projectfile.upload') + '</a>');
    $a.click(function (e) {
      e.preventDefault();
      Homey.showView('parse_knxproj');
      return false;
    });
    $a.appendTo($xmlText);
  });
</script>
